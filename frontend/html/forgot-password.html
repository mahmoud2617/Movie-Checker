<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MovieChecker — Reset Password</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/moviechecker_favicon_32.png">
    <link rel="icon" type="image/png" sizes="64x64" href="/assets/moviechecker_favicon_64.png">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/navbar.css">
    <link rel="stylesheet" href="/css/utilities.css">
    <style>
        /* ── Page layout ── */
        .fp-page {
            min-height: calc(100vh - 56px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
            background: var(--light-bg);
        }

        /* ── Card ── */
        .fp-card {
            background: var(--white);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.07);
            padding: clamp(2rem, 6vw, 3rem);
            width: 100%;
            max-width: 460px;
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) both;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(24px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ── Step indicator ── */
        .step-indicator {
            display: flex;
            align-items: center;
            gap: 0;
            margin-bottom: 2rem;
        }

        .step-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.72rem;
            font-weight: 800;
            flex-shrink: 0;
            transition: all 0.3s ease;
            border: 2px solid var(--border-light);
            background: var(--white);
            color: var(--text-light);
        }

        .step-dot.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-color: transparent;
            color: var(--white);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
        }

        .step-dot.done {
            background: var(--success);
            border-color: transparent;
            color: var(--white);
        }

        .step-line {
            flex: 1;
            height: 2px;
            background: var(--border-light);
            transition: background 0.3s ease;
        }

        .step-line.done {
            background: var(--success);
        }

        /* ── Heading ── */
        .fp-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-dark);
            letter-spacing: -0.4px;
            margin-bottom: 0.4rem;
            line-height: 1.2;
        }

        .fp-subtitle {
            color: var(--text-light);
            font-size: 0.92rem;
            line-height: 1.6;
            margin-bottom: 1.75rem;
        }

        /* ── Form elements ── */
        .fp-form-group {
            margin-bottom: 1.1rem;
        }

        .fp-form-group label {
            display: block;
            font-size: 0.78rem;
            font-weight: 700;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 0.45rem;
        }

        .fp-input {
            width: 100%;
            padding: 0.85rem 1rem;
            border: 2px solid var(--border-light);
            border-radius: 10px;
            font-size: 0.95rem;
            background: var(--white);
            color: var(--text-dark);
            transition: border-color 0.2s, box-shadow 0.2s;
            outline: none;
        }

        .fp-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* OTP input row */
        .otp-row {
            display: flex;
            gap: 0.5rem;
        }

        .otp-digit {
            flex: 1;
            padding: 0.85rem 0;
            border: 2px solid var(--border-light);
            border-radius: 10px;
            font-size: 1.3rem;
            font-weight: 700;
            text-align: center;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            color: var(--text-dark);
            background: var(--white);
            min-width: 0;
        }

        .otp-digit:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .otp-digit.filled {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.04);
        }

        /* ── Buttons ── */
        .fp-btn {
            width: 100%;
            padding: 0.9rem 1.5rem;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            border: none;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 0.5rem;
        }

        .fp-btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--white);
            box-shadow: 0 4px 14px rgba(99, 102, 241, 0.3);
        }

        .fp-btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 22px rgba(99, 102, 241, 0.4);
        }

        .fp-btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ── Back link ── */
        .fp-back {
            display: block;
            text-align: center;
            margin-top: 1.25rem;
            font-size: 0.88rem;
            color: var(--text-light);
        }

        .fp-back a {
            color: var(--primary-color);
            font-weight: 600;
            text-decoration: none;
        }

        .fp-back a:hover {
            text-decoration: underline;
        }

        /* ── Success state ── */
        .fp-success {
            text-align: center;
            padding: 1rem 0;
        }

        .fp-success-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: #ecfdf5;
            border: 2px solid #a7f3d0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.25rem;
        }

        .fp-success-title {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .fp-success-msg {
            color: var(--text-light);
            font-size: 0.92rem;
            line-height: 1.7;
            margin-bottom: 1.5rem;
        }

        /* ── Resend / timer ── */
        .resend-row {
            text-align: center;
            margin-top: 1rem;
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .resend-row button {
            background: none;
            border: none;
            color: var(--primary-color);
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0;
        }

        .resend-row button:disabled {
            color: var(--text-light);
            cursor: default;
        }
    </style>
</head>

<body>

    <!-- ==================== Navbar ==================== -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <h1><a href="/index.html" style="text-decoration:none;display:flex;gap:4px;align-items:baseline;">
                        <span class="brand-first">Movie</span><span class="brand-second">Checker</span>
                    </a></h1>
            </div>
            <ul class="nav-tabs">
                <li><a href="/index.html" data-nav="home">Home</a></li>
                <li><a href="/browse" data-nav="browse">Browse</a></li>
            </ul>
        </div>
    </nav>

    <!-- ==================== Main ==================== -->
    <div class="fp-page">
        <div class="fp-card" id="fpCard">

            <!-- Step indicator -->
            <div class="step-indicator" id="stepIndicator">
                <div class="step-dot active" id="dot1">1</div>
                <div class="step-line" id="line12"></div>
                <div class="step-dot" id="dot2">2</div>
                <div class="step-line" id="line23"></div>
                <div class="step-dot" id="dot3">3</div>
            </div>

            <!-- Dynamic content injected by JS -->
            <div id="fpContent"></div>

        </div>
    </div>

    <!-- Alert Toast & Spinner -->
    <div id="alertToast" class="alert-toast"></div>
    <div id="loadingSpinner" class="loading-spinner"></div>

    <!-- ==================== Scripts ==================== -->
    <script src="/env-config.js"></script>
    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/modal.js"></script>
    <script>
        // ── State ─────────────────────────────────────────────────────────────────
        let fp_step = 1;
        let fp_email = '';
        let fp_userId = null;   // read from URL param or entered by user
        let fp_token = null;   // RESET_PASSWORD JWT from step 2

        // ── Read optional ?email= param (passed when linking from login page) ─────
        const _params = new URLSearchParams(window.location.search);
        fp_email = _params.get('email') || '';
        fp_userId = _params.get('id') || null;

        // ── Step indicator update ─────────────────────────────────────────────────
        function updateStepIndicator(step) {
            for (let i = 1; i <= 3; i++) {
                const dot = document.getElementById('dot' + i);
                const line = document.getElementById('line' + i + (i + 1));
                dot.className = 'step-dot' + (i < step ? ' done' : i === step ? ' active' : '');
                if (line) line.className = 'step-line' + (i < step ? ' done' : '');
            }
            // Replace number with checkmark for done steps
            for (let i = 1; i < step; i++) {
                document.getElementById('dot' + i).innerHTML =
                    '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
            }
        }

        // ── Render helpers ────────────────────────────────────────────────────────
        function renderStep1() {
            fp_step = 1;
            updateStepIndicator(1);
            document.getElementById('fpContent').innerHTML = `
            <h1 class="fp-title">Forgot your password?</h1>
            <p class="fp-subtitle">Enter your account email and we will send you a 6&#8209;digit verification code.</p>
            <div class="fp-form-group">
                <label for="fpEmail">Email address</label>
                <input type="email" id="fpEmail" class="fp-input"
                       placeholder="you@example.com"
                       value="${escapeHtml(fp_email)}"
                       autocomplete="email">
            </div>
            <button class="fp-btn fp-btn-primary" id="fpBtn1" onclick="doStep1()">Send Code</button>
            <span class="fp-back"><a href="/index.html?showLogin=true">Back to Sign In</a></span>
        `;
            const el = document.getElementById('fpEmail');
            el?.focus();
            el?.addEventListener('keydown', e => { if (e.key === 'Enter') doStep1(); });
        }

        function renderStep2() {
            fp_step = 2;
            updateStepIndicator(2);
            document.getElementById('fpContent').innerHTML = `
            <h1 class="fp-title">Enter the code</h1>
            <p class="fp-subtitle">We sent a 6&#8209;digit code to <strong style="color:var(--text-dark)">${escapeHtml(fp_email)}</strong>. It expires in 10 minutes.</p>
            <div class="fp-form-group">
                <label>Verification code</label>
                <div class="otp-row" id="otpRow">
                    ${[1, 2, 3, 4, 5, 6].map(i => `<input type="text" inputmode="numeric" maxlength="1" class="otp-digit" id="otp${i}" autocomplete="one-time-code">`).join('')}
                </div>
            </div>
            <button class="fp-btn fp-btn-primary" id="fpBtn2" onclick="doStep2()" disabled>Verify Code</button>
            <div class="resend-row">
                Didn&rsquo;t receive it?
                <button id="resendBtn" onclick="doResend()" disabled>Resend in <span id="resendTimer">60</span>s</button>
            </div>
            <span class="fp-back"><a href="#" onclick="renderStep1(); return false;">Use a different email</a></span>
        `;
            initOtpInputs();
            startResendTimer();
            document.getElementById('otp1')?.focus();
        }

        function renderStep3() {
            fp_step = 3;
            updateStepIndicator(3);
            document.getElementById('fpContent').innerHTML = `
            <h1 class="fp-title">Set new password</h1>
            <p class="fp-subtitle">Choose a strong password for your account.</p>
            <div class="fp-form-group">
                <label for="fpNewPw">New password</label>
                <input type="password" id="fpNewPw" class="fp-input"
                       placeholder="Enter new password"
                       autocomplete="new-password">
            </div>
            <button class="fp-btn fp-btn-primary" id="fpBtn3" onclick="doStep3()">Reset Password</button>
            <span class="fp-back"><a href="/index.html?showLogin=true">Cancel</a></span>
        `;
            const el = document.getElementById('fpNewPw');
            el?.focus();
            el?.addEventListener('keydown', e => { if (e.key === 'Enter') doStep3(); });
        }

        function renderSuccess() {
            // Hide step indicator
            document.getElementById('stepIndicator').style.display = 'none';
            document.getElementById('fpContent').innerHTML = `
            <div class="fp-success">
                <div class="fp-success-icon">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
                <h2 class="fp-success-title">Password Reset</h2>
                <p class="fp-success-msg">Your password has been updated successfully.<br>You can now sign in with your new password.</p>
                <a href="/index.html?showLogin=true" class="fp-btn fp-btn-primary" style="display:block;text-decoration:none;text-align:center;">Back to Sign In</a>
            </div>
        `;
        }

        // ── OTP input wiring ──────────────────────────────────────────────────────
        function initOtpInputs() {
            const inputs = document.querySelectorAll('.otp-digit');
            inputs.forEach((inp, idx) => {
                inp.addEventListener('input', () => {
                    // Only keep single digit
                    inp.value = inp.value.replace(/\D/, '').slice(-1);
                    inp.classList.toggle('filled', inp.value !== '');
                    if (inp.value && idx < 5) inputs[idx + 1].focus();
                    checkOtpComplete();
                });
                inp.addEventListener('keydown', e => {
                    if (e.key === 'Backspace' && !inp.value && idx > 0) {
                        inputs[idx - 1].focus();
                        inputs[idx - 1].value = '';
                        inputs[idx - 1].classList.remove('filled');
                        checkOtpComplete();
                    }
                    if (e.key === 'Enter') doStep2();
                });
                inp.addEventListener('paste', e => {
                    e.preventDefault();
                    const pasted = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g, '').slice(0, 6);
                    pasted.split('').forEach((ch, i) => {
                        if (inputs[i]) {
                            inputs[i].value = ch;
                            inputs[i].classList.add('filled');
                        }
                    });
                    if (pasted.length > 0) inputs[Math.min(pasted.length, 5)].focus();
                    checkOtpComplete();
                });
            });
        }

        function checkOtpComplete() {
            const inputs = document.querySelectorAll('.otp-digit');
            const full = Array.from(inputs).every(i => i.value !== '');
            const btn = document.getElementById('fpBtn2');
            if (btn) btn.disabled = !full;
            if (full) doStep2();
        }

        function getOtpValue() {
            return Array.from(document.querySelectorAll('.otp-digit')).map(i => i.value).join('');
        }

        // ── Resend timer ──────────────────────────────────────────────────────────
        let _resendInterval = null;
        function startResendTimer(seconds = 60) {
            let remaining = seconds;
            const btn = document.getElementById('resendBtn');
            if (_resendInterval) clearInterval(_resendInterval);
            _resendInterval = setInterval(() => {
                remaining--;
                if (btn) {
                    btn.innerHTML = `Resend in <span id="resendTimer">${remaining}</span>s`;
                }
                if (remaining <= 0) {
                    clearInterval(_resendInterval);
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = 'Resend code';
                    }
                }
            }, 1000);
        }

        async function doResend() {
            const btn = document.getElementById('resendBtn');
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Sending...';
            }
            await doStep1(true); // silent re-send
            startResendTimer();
        }

        // ── Step actions ──────────────────────────────────────────────────────────
        async function doStep1(silent = false) {
            const emailEl = document.getElementById('fpEmail');
            if (emailEl) fp_email = emailEl.value.trim();
            if (!fp_email) { showAlert('Please enter your email address', 'warning'); return; }

            const btn = document.getElementById('fpBtn1');
            if (btn) { btn.disabled = true; btn.textContent = 'Sending…'; }
            showLoadingSpinner(true);

            try {
                const resp = await fetch(API_BASE_URL + API_ENDPOINTS.resetPasswordRequest, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: fp_email })
                });

                if (resp.ok || resp.status === 204) {
                    // Silently capture userId from response — user never sees it
                    try {
                        const ct = resp.headers.get('content-type') || '';
                        if (ct.includes('application/json')) {
                            const data = await resp.json();
                            fp_userId = data?.userId ?? null;
                        }
                    } catch (_) { }

                    if (!silent) {
                        renderStep2();
                    } else {
                        showAlert('New code sent — check your inbox', 'success');
                    }
                } else {
                    const msg = await safeParseErrorMessage(resp);
                    showAlert(msg || 'Could not send verification code', 'error');
                    if (btn) { btn.disabled = false; btn.textContent = 'Send Code'; }
                }
            } catch (err) {
                console.error('fp step1 error', err);
                showAlert('Could not reach the server. Please try again.', 'error');
                if (btn) { btn.disabled = false; btn.textContent = 'Send Code'; }
            } finally {
                showLoadingSpinner(false);
            }
        }

        async function doStep2() {
            const code = getOtpValue();
            if (code.length !== 6) return;

            if (!fp_userId) {
                showAlert('Something went wrong. Please start again.', 'error');
                renderStep1();
                return;
            }

            const btn = document.getElementById('fpBtn2');
            if (btn) { btn.disabled = true; btn.textContent = 'Verifying…'; }
            showLoadingSpinner(true);

            try {
                const url = `${API_BASE_URL}${API_ENDPOINTS.resetPasswordVerify}?id=${encodeURIComponent(fp_userId)}&code=${encodeURIComponent(code)}`;
                const resp = await fetch(url, { method: 'PATCH' });

                if (resp.ok) {
                    const data = await resp.json();
                    fp_token = data.token || data.accessToken;
                    renderStep3();
                } else {
                    const msg = await safeParseErrorMessage(resp);
                    showAlert(msg || 'Invalid or expired code', 'error');
                    // Clear OTP so user can retry
                    document.querySelectorAll('.otp-digit').forEach(i => { i.value = ''; i.classList.remove('filled'); });
                    document.getElementById('otp1')?.focus();
                    if (btn) { btn.disabled = true; btn.textContent = 'Verify Code'; }
                }
            } catch (err) {
                console.error('fp step2 error', err);
                showAlert('Could not reach the server. Please try again.', 'error');
                if (btn) { btn.disabled = false; btn.textContent = 'Verify Code'; }
            } finally {
                showLoadingSpinner(false);
            }
        }

        async function doStep3() {
            const newPw = document.getElementById('fpNewPw')?.value.trim();
            if (!newPw) { showAlert('Please enter a new password', 'warning'); return; }
            if (!fp_token) { showAlert('Session expired. Please start again.', 'error'); renderStep1(); return; }

            const btn = document.getElementById('fpBtn3');
            if (btn) { btn.disabled = true; btn.textContent = 'Resetting…'; }
            showLoadingSpinner(true);

            try {
                const resp = await fetch(API_BASE_URL + API_ENDPOINTS.resetPasswordConfirm, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${fp_token}`
                    },
                    body: JSON.stringify({ newPassword: newPw })
                });

                if (resp.ok || resp.status === 204) {
                    fp_token = null;
                    renderSuccess();
                } else {
                    const msg = await safeParseErrorMessage(resp);
                    showAlert(msg || 'Failed to reset password', 'error');
                    if (btn) { btn.disabled = false; btn.textContent = 'Reset Password'; }
                }
            } catch (err) {
                console.error('fp step3 error', err);
                showAlert('Could not reach the server. Please try again.', 'error');
                if (btn) { btn.disabled = false; btn.textContent = 'Reset Password'; }
            } finally {
                showLoadingSpinner(false);
            }
        }

        // If we already have userId from URL, skip showing it to user and go straight to step 1
        renderStep1();
    </script>
</body>

</html>